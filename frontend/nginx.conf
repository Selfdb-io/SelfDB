# Production-ready nginx configuration for SelfDB Frontend
# Serves static React app and proxies API requests to backend services

# Define upstream servers for backend services
upstream backend_api {
    server backend:${API_PORT};
}

upstream storage_service {
    server storage:${STORAGE_PORT};
}

upstream functions_service {
    server deno-runtime:${DENO_PORT};
}

server {
    listen 80;
    server_name _;

    # Root directory for static files
    root /usr/share/nginx/html;
    index index.html index.htm;

    # Logging
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log warn;

    # Frontend health endpoint
    location /frontend/health {
        add_header Content-Type application/json;
        return 200 '{"service":"frontend","status":"ready","version":"0.1.0-test","server":"nginx"}';
    }

    # Backend health endpoint
    location ^~ /health {
        proxy_pass http://backend_api/health;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-API-Key ${API_KEY};
    }

    # Backend status endpoint
    location ^~ /api/v1/status {
        proxy_pass http://backend_api/api/v1/status;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-API-Key ${API_KEY};
    }



    location ^~ /docs {
        proxy_pass http://backend_api/openapi.json;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Authentication endpoints - rewrite /api/v1/auth/* to /auth/*
    location ^~ /api/v1/auth/ {
        rewrite ^/api/v1/auth/(.*)$ /auth/$1 break;
        proxy_pass http://backend_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-API-Key ${API_KEY};
    }

    # Realtime WebSocket endpoint
    location ^~ /api/v1/realtime {
        proxy_pass http://backend_api/api/v1/realtime;
        proxy_http_version 1.1;
        
        # WebSocket upgrade headers
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Standard proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-API-Key ${API_KEY};
        
        # WebSocket timeouts
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }

    # User management endpoints
    location ^~ /api/v1/users {
        proxy_pass http://backend_api/api/v1/users;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-API-Key ${API_KEY};
    }

    # Table management endpoints
    location ^~ /api/v1/tables {
        proxy_pass http://backend_api/api/v1/tables;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-API-Key ${API_KEY};
    }

    # Bucket endpoints
    location ^~ /api/v1/buckets {
        proxy_pass http://backend_api/api/v1/buckets;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-API-Key ${API_KEY};
    }

    # File endpoints
    location ^~ /api/v1/files {
        proxy_pass http://backend_api/api/v1/files;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-API-Key ${API_KEY};
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
        client_max_body_size 0;
        
        # Disable buffering for streaming file downloads
        proxy_buffering off;
        proxy_request_buffering off;
    }

    # Storage service endpoints
    location ^~ /api/v1/storage {
        proxy_pass http://storage_service/api/v1/storage;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-API-Key ${API_KEY};
        
        # Increased timeouts for file uploads
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
        client_max_body_size 0;
    }

    # SQL execution endpoints
    location ^~ /api/v1/sql {
        proxy_pass http://backend_api/api/v1/sql;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-API-Key ${API_KEY};
        
        # Increased timeouts for long-running queries
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
    }

    # Storage health endpoint
    location ^~ /storage/health {
        rewrite ^/storage/health$ /health break;
        proxy_pass http://storage_service;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-API-Key ${API_KEY};
    }

    # Functions endpoints (route through backend API)
    location ^~ /api/v1/functions {
        proxy_pass http://backend_api/api/v1/functions;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-API-Key ${API_KEY};
        
        # Increased timeouts for function execution
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
    }

    # Webhooks endpoints (route through backend API)
    location ^~ /api/v1/webhooks {
        proxy_pass http://backend_api/api/v1/webhooks;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-API-Key ${API_KEY};
    }

    # CORS management endpoints (route through backend API)
    location ^~ /api/v1/cors {
        proxy_pass http://backend_api/api/v1/cors;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-API-Key ${API_KEY};
    }

    # Functions health endpoint
    location ^~ /functions/health {
        rewrite ^/functions/health$ /health break;
        proxy_pass http://functions_service;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-API-Key ${API_KEY};
    }

    # Cache control for static assets (CSS, JS, images, fonts)
    location ~* \.(?:css|js|jpg|jpeg|gif|png|ico|svg|woff|woff2|ttf|eot)$ {
        try_files $uri =404;
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
        
        # Correct MIME types
        types {
            text/css css;
            application/javascript js;
            image/svg+xml svg;
        }
    }

    # Prevent caching for index.html
    location = /index.html {
        expires -1;
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
    }

    # SPA fallback - serve index.html for all other routes
    location / {
        try_files $uri $uri/ /index.html;
    }

    # Enable gzip compression
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_buffers 16 8k;
    gzip_http_version 1.1;
    gzip_types 
        text/plain 
        text/css 
        application/json 
        application/javascript 
        text/xml 
        application/xml 
        application/xml+rss 
        text/javascript 
        image/svg+xml 
        application/vnd.ms-fontobject 
        application/x-font-ttf 
        font/opentype;
}
